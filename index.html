<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>JioTV+ IPTV Browser Player</title>
  <link href="https://vjs.zencdn.net/8.6.1/video-js.css" rel="stylesheet" />
  <script src="https://vjs.zencdn.net/8.6.1/video.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/videojs-contrib-eme@3.10.0/dist/videojs-contrib-eme.min.js"></script>
  <style>
    body { background: #000; color: #fff; font-family: sans-serif; margin:0; padding:1rem; }
    .controls { margin-bottom: 1rem; }
    video { width: 100%; max-width:800px; height: auto; display:block; margin:auto; }
  </style>
</head>
<body>

  <h1>ðŸ“º JioTV+ Channel Player</h1>
  <div class="controls">
    <select id="channelSelect"></select>
  </div>
  <video id="player" class="video-js vjs-default-skin" controls autoplay preload="auto"></video>

  <script>
    async function fetchAndParseM3U(url) {
      const res = await fetch(url);
      const text = await res.text();
      const lines = text.split(/\r?\n/);
      const channels = [];
      for (let i=0; i<lines.length; i++) {
        if (lines[i].startsWith("#EXTINF")) {
          const info = lines[i];
          const urlLine = lines[i+3];  // stream URL
          const licenseLine = lines[i+2];
          const titleMatch = info.match(/tvg-name="([^"]+)"/);
          const title = titleMatch ? titleMatch[1] : "Channel";
          const kidMatch = licenseLine.match(/keyid=([^&]+)&key=([^"]+)/);
          const [_, kid, key] = kidMatch || [];
          const mpdMatch = urlLine.split("|")[0];
          channels.push({ title, mpd: mpdMatch, kid, key });
        }
      }
      return channels;
    }

    function initPlayer() {
      const player = videojs('player');
      player.ready(() => {
        player.tech().xhr.beforeRequest = function(options) {
          options.headers = {
            'User-Agent': 'plaYtv/7.1.3 (Linux;Android 13)',
            'Referer': 'https://www.jiotv.com',
            'Origin': 'https://www.jiotv.com'
          };
          return options;
        };
      });
      return player;
    }

    async function main() {
      const channels = await fetchAndParseM3U('https://jiotvplus.iptv07india.workers.dev/playlist');
      const select = document.getElementById('channelSelect');

      channels.forEach((ch, idx) => {
        const opt = document.createElement('option');
        opt.value = idx;
        opt.textContent = ch.title;
        select.appendChild(opt);
      });

      const player = initPlayer();

      function loadChannel(idx) {
        const ch = channels[idx];
        const src = { src: ch.mpd, type: 'application/dash+xml' };
        if (ch.kid && ch.key) {
          src.keySystems = { 'org.w3.clearkey': { clearkeys: { [ch.kid]: ch.key } } };
        }
        player.src(src);
        player.play();
      }

      select.addEventListener('change', () => loadChannel(select.value));
      if (channels.length > 0) loadChannel(0);
    }

    main();
  </script>

</body>
</html>
