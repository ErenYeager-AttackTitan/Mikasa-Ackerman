<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Channel Player</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- JWPlayer -->
  <script src="https://cdn.jwplayer.com/libraries/aVr2lJgW.js"></script>

  <style>
    body {
      margin: 0;
      background: #000;
      color: #fff;
      font-family: Arial, sans-serif;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    #player-frame {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #000;
    }
    #player { width: 100%; height: 100%; }

    #info {
      padding: 10px;
      background: #111;
      font-size: 14px;
    }
    #player-title { font-size: 18px; font-weight: bold; }
    #channel-meta { color: #bbb; margin-top: 4px; }
    #channel-desc { margin-top: 8px; font-size: 13px; }

    #skeleton, #error {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,0.8);
      z-index: 10;
      color: #fff;
      font-size: 18px;
    }
  </style>
</head>
<body>
  <!-- Player container -->
  <div id="player-frame">
    <div id="player"></div>
    <div id="skeleton">⏳ Loading channel...</div>
    <div id="error"><span id="error-text"></span></div>
  </div>

  <!-- Info -->
  <div id="info">
    <div id="player-title">Loading...</div>
    <div id="channel-meta"></div>
    <div id="channel-desc"></div>
  </div>

  <script>
    let playerInstance = null;
    jwplayer.key = 'XSuP4qMl+9tK17QNb+4+th2Pm9AWgMO/cYH8CI0HGGr7bdjo';

    document.addEventListener('DOMContentLoaded', async () => {
      const id = new URLSearchParams(location.search).get('id');
      if (!id) return showError("No channel ID provided");
      await loadChannel(id);
    });

    async function loadChannel(id) {
      try {
        showSkeleton("Fetching channel...");
        const res = await fetch("https://hidden-boat-b444.saqlainhaider8198.workers.dev/");
        if (!res.ok) throw new Error("Failed to fetch channel list");

        const channels = await res.json();
        const channel = channels.find(c => c.channel_id === id);
        if (!channel) throw new Error("Channel not found");

        updatePlayer(channel);
        updateChannelInfo(channel);
        hideSkeleton();
      } catch (e) {
        showError(e.message);
      }
    }

    function updatePlayer(channel) {
      setupXHRInterceptor(channel.cookie);
      playerInstance = jwplayer("player").setup({
        playlist: [{
          title: channel.channel_name,
          image: channel.channel_logo,
          file: channel.channel_url,
          drm: {
            clearkey: { keyId: channel.keyId, key: channel.key }
          }
        }],
        width: "100%",
        height: "100%",
        autostart: true,
        controls: true,
        skin: { name: "custom" }
      });

      playerInstance.on("error", e => {
        showError("Playback error: " + e.message);
      });
    }

    function updateChannelInfo(c) {
      document.getElementById("player-title").textContent = c.channel_name;
      document.getElementById("channel-meta").textContent = `${c.channel_genre} • ${c.language}`;
      document.getElementById("channel-desc").innerHTML = `
        Now playing: <b>${c.channel_name}</b><br>
        Genre: ${c.channel_genre}<br>
        Language: ${c.language}<br>
        Last update: ${c.last_update}
      `;
    }

    function setupXHRInterceptor(cookie) {
      const orig = XMLHttpRequest.prototype.open;
      XMLHttpRequest.prototype.open = function(m, url) {
        try {
          if (url && typeof url === "string" && !url.includes("__hdnea__")) {
            url += (url.includes("?") ? "&" : "?") + cookie;
            arguments[1] = url;
          }
        } catch(e){}
        return orig.apply(this, arguments);
      };
    }

    function showSkeleton(msg="Loading...") {
      const el = document.getElementById("skeleton");
      el.textContent = msg;
      el.style.display = "flex";
    }
    function hideSkeleton() {
      document.getElementById("skeleton").style.display = "none";
    }
    function showError(msg) {
      document.getElementById("error-text").textContent = msg;
      document.getElementById("error").style.display = "flex";
      hideSkeleton();
    }
  </script>
</body>
</html>
